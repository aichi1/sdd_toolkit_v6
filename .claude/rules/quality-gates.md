# Quality Gates - 品質ゲート定義

## 目的
各Phase完了時の品質基準を明確化し、次Phaseに進む前の必須チェック項目を定義する。

## 品質ゲートとは

```
Phase N実行
    ↓
  成果物生成（Builder）
    ↓
  検証（Validator）
    ↓
【品質ゲート】← ここで合否判定
    ↓ PASS
  Phase N完了
    ↓
  Phase N+1へ
```

品質ゲートを通過しない限り、次Phaseには進めない。
（ユーザーが明示的にスキップした場合を除く）

---

## 全Phase共通の品質ゲート

### Gate 0: 基本完全性チェック

**目的**: Phase実行の基本条件を満たしているか

**チェック項目:**
- [ ] **成果物ファイル存在**
  - SKILL.mdで指定された全deliverableが存在する
  - ファイルサイズが0バイトでない
  
- [ ] **メタデータ完全性**
  - `.metadata.json`が存在する
  - 必須フィールドが全て記載されている
    - builder_session_id
    - deliverables リスト
    - completed_at
  
- [ ] **フォーマット適合**
  - Markdownファイルが有効な構文である
  - 表やリストが正しくレンダリングされる
  - 画像リンクがあれば全て存在する

**合格基準:**
```
全てのチェック項目が ✓ → PASS
1つでも ✗ → FAIL（次Gateに進めない）
```

**不合格時の対処:**
```
- ファイル未作成 → Builder再実行
- メタデータ不備 → .metadata.json修正
- フォーマット不正 → ファイル修正
```

---

### Gate 1: docs/要件充足チェック

**目的**: docs/に記載された全要件を満たしているか

**チェック項目:**
- [ ] **必須要件の充足**
  - docs/で「必須」とされた全項目が成果物に含まれる
  - 漏れがない
  
- [ ] **スコープ遵守**
  - docs/scope.mdの範囲内
  - 除外事項が含まれていない
  
- [ ] **制約条件の遵守**
  - 文字数、ページ数制限（あれば）
  - 納期（Phase見積もり時間）
  - 技術的制約
  
- [ ] **ターゲット適合**
  - docs/audience.mdで定義された読者レベル
  - 専門用語の扱い
  - 説明の詳細度

**合格基準:**
```
Critical要件: 100%充足 → PASS
Critical要件: 1つでも未充足 → NEEDS_REVISION
Optional要件: 充足率は問わない
```

**不合格時の対処:**
```
- 要件漏れ → Builder修正（該当箇所追加）
- スコープ逸脱 → Builder修正（余分な箇所削除）
- 制約違反 → Builder修正（調整）
```

---

### Gate 2: SKILL.md品質基準チェック

**目的**: SKILL.mdで定義されたQuality Criteriaを満たしているか

**チェック項目:**
- [ ] **手順完全実行**
  - SKILL.mdの全Stepが実行されている
  - 飛ばされたStepがない
  
- [ ] **品質基準達成**
  - SKILL.mdのQuality Criteriaが全て✓
  - 各基準の証拠が成果物に存在
  
- [ ] **出力仕様適合**
  - 指定されたファイル名
  - 指定された構造
  - 指定された形式

**合格基準:**
```
全Quality Criteria達成 → PASS
Critical Criteriaのみ達成 → NEEDS_REVISION
Critical Criteria未達 → FAIL
```

**不合格時の対処:**
```
- 手順未実行 → Builder再実行
- 品質基準未達 → Builder修正
- 出力仕様不適合 → Builder修正
```

---

### Gate 3: 一貫性チェック

**目的**: 前Phase成果物や他の情報源との一貫性を保っているか

**チェック項目:**
- [ ] **前Phase整合性**
  - Phase N-1の成果物と矛盾がない
  - 数値、固有名詞の一致
  - 結論の連続性
  
- [ ] **docs/整合性**
  - 複数のdocs/ファイル間で矛盾がない
  - 用語の統一
  
- [ ] **内部整合性**
  - 成果物内での矛盾がない
  - 主張と根拠の対応
  - 表とテキストの一致

**合格基準:**
```
重大な矛盾なし → PASS
軽微な矛盾（用語の揺れ等） → NEEDS_REVISION
重大な矛盾（数値が違う等） → FAIL
```

**不合格時の対処:**
```
- 前Phase矛盾 → どちらが正しいか確認し修正
- 内部矛盾 → Builder修正
- 用語の揺れ → 統一ルール作成し修正
```

---

## Phase別の追加品質ゲート

### Phase 1（調査・分析）の追加ゲート

**Gate 1.1: データ信頼性チェック**
- [ ] 全データソースが明記されている
- [ ] 情報源が信頼できる（公式サイト、論文等）
- [ ] データ取得日が記載されている
- [ ] 引用形式が統一されている

**Gate 1.2: 網羅性チェック**
- [ ] docs/scope.mdの調査対象が全てカバーされている
- [ ] 評価軸（あれば）が全て調査されている
- [ ] 明らかな漏れがない

**合格基準:**
```
データソース不明: 1箇所でも → NEEDS_REVISION
調査対象漏れ: 1つでも → FAIL
```

---

### Phase 2（比較・評価）の追加ゲート

**Gate 2.1: 公平性チェック**
- [ ] 全対象が同じ基準で評価されている
- [ ] 評価軸が全対象に適用されている
- [ ] バイアスがない（特定の対象に有利/不利な基準）

**Gate 2.2: 根拠明確性チェック**
- [ ] 各評価に根拠が記載されている
- [ ] 根拠がPhase 1データまたはdocs/に遡れる
- [ ] 主観的評価には「主観」と明記

**Gate 2.3: 推奨案の妥当性**
- [ ] 推奨案が評価結果と整合している
- [ ] 推奨理由が明確
- [ ] 代替案（あれば）との比較が明確

**合格基準:**
```
根拠不明: 3箇所以上 → FAIL
根拠不明: 1-2箇所 → NEEDS_REVISION
推奨案が評価と矛盾 → FAIL
```

---

### Phase 3（報告書作成）の追加ゲート

**Gate 3.1: 構成適合チェック**
- [ ] docs/format.mdの構成に従っている
- [ ] 必須セクションが全て存在
- [ ] セクション順序が適切

**Gate 3.2: 完成度チェック**
- [ ] 誤字脱字が最小限（10箇所未満）
- [ ] 図表にキャプションがある
- [ ] 目次（あれば）とページが一致
- [ ] 参考文献リストが完全

**Gate 3.3: 独立性チェック**
- [ ] この報告書だけで理解できる
- [ ] 前Phase成果物を見なくても分かる
- [ ] 必要な情報が全て含まれている

**合格基準:**
```
構成不適合 → FAIL
誤字脱字多数（30箇所以上） → NEEDS_REVISION
独立性不足（重要情報欠落） → FAIL
```

---

## 品質ゲート通過プロセス

### ステップ1: 自動チェック
```
Builder完了直後に実行:
  1. Gate 0（基本完全性）を自動チェック
  2. 明らかなNG項目を検出
  3. NGがあれば即座に Builder にフィードバック

所要時間: <1分
```

### ステップ2: Validator検証
```
Validator Agent起動:
  1. Gate 1（docs/要件）をチェック
  2. Gate 2（SKILL.md品質）をチェック
  3. Gate 3（一貫性）をチェック
  4. Phase別追加ゲートをチェック
  5. 検証レポート作成

所要時間: 5-10分（Phase規模による）
```

### ステップ3: 判定
```
全ゲート PASS:
  → Phase完了、次Phaseへ

一部ゲート NEEDS_REVISION:
  → Builder修正サイクル
  → 修正後、ステップ2から再実行

いずれかゲート FAIL:
  → メインセッションに報告
  → 根本原因分析
  → SKILL.md or docs/ 見直し
```

---

## 品質ゲートの記録

### 記録フォーマット
```json
// outputs/phase-{N}/.validation/quality-gates.json
{
  "phase": 2,
  "timestamp": "2026-02-05T12:00:00Z",
  "gates": [
    {
      "gate_id": "gate-0",
      "name": "基本完全性チェック",
      "status": "pass",
      "checks": [
        {"item": "成果物ファイル存在", "result": "pass"},
        {"item": "メタデータ完全性", "result": "pass"},
        {"item": "フォーマット適合", "result": "pass"}
      ]
    },
    {
      "gate_id": "gate-1",
      "name": "docs/要件充足チェック",
      "status": "pass",
      "checks": [
        {"item": "必須要件の充足", "result": "pass"},
        {"item": "スコープ遵守", "result": "pass"},
        {"item": "制約条件の遵守", "result": "pass"},
        {"item": "ターゲット適合", "result": "pass"}
      ]
    },
    {
      "gate_id": "gate-2",
      "name": "SKILL.md品質基準チェック",
      "status": "needs_revision",
      "checks": [
        {"item": "手順完全実行", "result": "pass"},
        {"item": "品質基準達成", "result": "fail", "reason": "Criteria 3未達"},
        {"item": "出力仕様適合", "result": "pass"}
      ],
      "issues": [
        {
          "criteria": "データソース明記",
          "status": "未達",
          "location": "comparison-table.md 表1",
          "fix": "各データの出典を注釈に追加"
        }
      ]
    },
    {
      "gate_id": "gate-2.2",
      "name": "根拠明確性チェック",
      "status": "pass",
      "checks": [
        {"item": "各評価に根拠あり", "result": "pass"},
        {"item": "根拠の遡及性", "result": "pass"},
        {"item": "主観評価の明記", "result": "pass"}
      ]
    }
  ],
  "overall_status": "needs_revision",
  "blocking_gates": ["gate-2"],
  "next_action": "Builder修正サイクル"
}
```

---

## 品質ゲートのカスタマイズ

### プロジェクト固有のゲート追加

**追加方法:**
```markdown
// skills/phase-{N}/SKILL.md に追記

## Custom Quality Gates
本Phaseでは以下の追加品質ゲートを適用:

### Gate X.1: {ゲート名}
**目的**: {なぜこのゲートが必要か}
**チェック項目**:
  - [ ] {項目1}
  - [ ] {項目2}
**合格基準**: {基準}
```

**例:**
```markdown
## Custom Quality Gates

### Gate 2.4: 性能データ正確性チェック
**目的**: ベンチマーク結果の信頼性を保証
**チェック項目**:
  - [ ] 全ベンチマークで実行環境が明記されている
  - [ ] 測定回数が3回以上
  - [ ] 標準偏差が平均値の10%以内
**合格基準**: 全項目クリア
```

---

## 品質ゲート免除ルール

### 免除が許可されるケース

**ケース1: ユーザー明示承認**
```
状況:
  Validator: "Gate 2でCritical Issue 2件"
  User: "この問題は承知で進めたい"

対処:
  - statusを "completed_with_issues" に設定
  - 問題をmetadata.jsonに記録
  - finalize時に警告表示
```

**ケース2: 探索的フェーズ**
```
状況:
  Phase 1が探索的で、品質基準が流動的

対処:
  - SKILL.mdに「探索フェーズ」と明記
  - 品質ゲートを緩和（NEEDS_REVISIONでも進行可）
  - Phase 2で再確認
```

**ケース3: 時間制約**
```
状況:
  納期が迫っており、完璧を求めると間に合わない

対処:
  - Critical Issueのみ修正必須
  - Suggestionsは免除
  - retrospectiveで「時間不足」を記録
```

### 免除が禁止されるケース

**禁止1: Gate 0（基本完全性）**
```
理由: 成果物が存在しない、壊れている状態で次に進むのは無意味
→ 必ず修正必須
```

**禁止2: docs/必須要件の未充足**
```
理由: プロジェクトの目的を果たせない
→ 必ず修正必須
```

**禁止3: 重大な矛盾**
```
理由: 成果物の信頼性が損なわれる
→ 必ず修正必須
```

---

## 品質指標

### Phase完了品質スコア

```
Phase Quality Score (PQS):
  = (通過ゲート数 / 全ゲート数) × 100

例:
  Phase 2: 8ゲート中7ゲート通過
  PQS = (7/8) × 100 = 87.5%

評価:
  PQS >= 95%: 優良
  PQS 80-94%: 良好
  PQS 60-79%: 改善余地あり
  PQS < 60%: 要見直し
```

### プロジェクト全体品質スコア

```
Project Quality Score (PjQS):
  = Σ(各Phase の PQS) / Phase数

例:
  Phase 1: 95%
  Phase 2: 87%
  Phase 3: 100%
  PjQS = (95 + 87 + 100) / 3 = 94%
```

---

## トラブルシューティング

### 問題: 品質ゲートが厳しすぎる
```
症状:
  Validatorで何度もNEEDS_REVISION
  PQS < 70% が続く

原因:
  - SKILL.mdの品質基準が過剰
  - docs/の要件が曖昧で解釈が分かれる

対処:
  1. SKILL.mdのQuality Criteriaを見直し
  2. docs/を明確化
  3. 品質ゲートの優先度を再調整
```

### 問題: 品質ゲートが緩すぎる
```
症状:
  全Phase即PASS
  しかし成果物に問題が多い

原因:
  - 品質ゲートのチェック項目が不足
  - Validatorが機能していない

対処:
  1. Phase別追加ゲートを設定
  2. Validator検証ロジックを強化
  3. retrospectiveで「見落とした問題」を分析
```

### 問題: ゲート判定が曖昧
```
症状:
  PASSかNEEDS_REVISIONか判断に迷う

原因:
  - 合格基準が定量的でない
  - 「適切」「十分」等の曖昧な表現

対処:
  1. 合格基準を定量化
     例: 「誤字が少ない」→「誤字10箇所未満」
  2. サンプル基準を用意
     例: 「良い例」「悪い例」を明示
```

---

## まとめ

品質ゲートは**「次に進んで良いか」の明確な判断基準**。

**全Phase共通:**
- Gate 0: 基本完全性（必須）
- Gate 1: docs/要件充足（必須）
- Gate 2: SKILL.md品質基準（必須）
- Gate 3: 一貫性（推奨）

**Phase別追加:**
- Phase 1: データ信頼性、網羅性
- Phase 2: 公平性、根拠明確性、推奨妥当性
- Phase 3: 構成適合、完成度、独立性

**運用原則:**
- Gate 0, 必須要件は免除不可
- その他は状況に応じて免除可（記録必須）
- 品質スコアで継続的改善

品質ゲートを守ることで、**後戻りを最小化し、高品質な成果物**を保証できる。